{% extends "bootstrap/base.html" %}

{% block title %}
AI CCTV Dashboard
{% endblock %}

{% block styles %}
{{super()}}
{% include "header.html" %}

{% endblock %}

{% block content %}


<div class="container" id="app">
<!--
  <div class="cameras" v-for="(camera, index) in cameras">
    <div class="camera col-md-3" style="height:300px">
      <img v-bind:src="camera.pic_path" width="200" />
    </div>
    <div v-if="index % 4 === 3">
      <div class="w-100 d-none d-md-block"></div>
    </div>
  </div>
-->
  <div class="cameras" >
    <table class="table table-sm table-hover table-dark">
      <thead>
        <tr>
          <th scope="col" class="col-md-1">Camera Name</th>
          <th scope="col" class="col-md-4">Live View</th>
          <th scope="col" class="col-md-2">Detections</th>
          <th scope="col" class="col-md-2">Stats</th>
          <th scope="col" class="col-md-2">Created At</th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(camera, index) in cameras">
          <td class="col-md-1">[[index]]_[[camera.cam_name]]</td>
          <td class="col-md-4"><img v-bind:src="camera.pic_path" width="300"/></td>
          <td class="col-md-2">[[camera.num_persons]], [[camera.num_luggages]]</td>
          <td class="col-md-2">
            <!--<bar-chart></bar-chart>-->
            <div class="chart-container" style="width:200px; height:100px;">
              <canvas v-bind:id="'bar'+index"></canvas>
            </div>
          </td>
          <td class="col-md-2">[[camera.created_at]]</td>
        </tr>
      </tbody>
    </table>
  </div>
</div><!-- /.container -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.1/Chart.min.js"></script>
<script src="https://unpkg.com/vue-chartjs/dist/vue-chartjs.min.js"></script>

<script>
var num_camera=1; //default cameras
var charts=[];

var app = new Vue({
  el: '#app',
  delimiters: ['[[',']]'],
  data: {
    right_message: 'Hello Vue!',
    imageSRC: "/static/default.jpg",
    cameras: []

  },
  created:function(){
      console.log("APP started.");
  },
  mounted:function(){
    var _this=this;
    $.getJSON("/api/cameras", function(response_data){
      _this.cameras=response_data.cameras;
    });
  }
});

setInterval(function(){
  $.getJSON("/api/camera_detections", function(response_data){
    app.cameras=response_data;
    renew_charts(app.cameras.length); 
  });

},2000);


function renew_charts(num){
  // Bar chart
  num=5;
  for(i=0; i<num; i++){
    if(charts.length>i){ //already have charts
	cam_name =app.cameras[i].cam_name;
	(function(index){
	 $.getJSON("/api/resampled_dets/"+cam_name, function(response_data){
	    for(j=0; j<20; j++){
	      charts[index].data.datasets[0].data[j]=response_data[j].num_persons;	  
	    }
	    charts[index].update()
	  });
	})(i);
    }else{
    charts[i]=new Chart(document.getElementById("bar"+i), {
        type: 'bar',
        data: {
          labels: ["a", "b", "c", "d", "e", "f","g","h","i","j","k","l","m","n","o","16","17","18","19","20"],
          datasets: [
            {
              label: "people",
              backgroundColor: ["#AAAAAA", "#AAAAAA","#AA2222","#22AA22","#2222AA"],
              data: [1,0.3,5,6,7,9,10,8,2.3,4.5,3,2.8,2.2,2.0,1.8,1.7,1.6,1.5,1.4,1.3],
                    borderColor: '#555555',
                    borderWidth: 1
            }
          ]
        },
        options: {
          responsive: true,     
          maintainAspectRatio: false,
          legend: { display: false },
          title: {
            display: true,
            text: '10 Minute Passengers'
          },
          scales: {
                  xAxes: [{
                    display: false,
                gridLines: {
                    color: "rgba(0, 0, 0, 0)"
                },
                barPercentage: 1.00,
                categoryPercentage: 1.00,
            }],
            yAxes: [{
                    display: false,
                gridLines: {
                    color: "rgba(0, 0, 0, 0)",
                },
                    ticks:{
                            maxTicksLimit: 1,
                            _min: -0.1 
                    }
            }]
          }
        }
      });
    }
  }//for loop end
}

</script>
{% endblock %}
